---

# Initial definitions
dist: xenial
language: python
python: "2.7"

# Branch limitations
branches:
  only:
  - master
  - ansible-3
  - ansible-4

# Environments enumeration
env:
  - WORK_ENV=stage
  - WORK_ENV=prod

# Preliminary commands - ensure all packages are up to date
before_install:
  - sudo apt-get update -y

# Install the needed software: Packer, Terraform, Ansible, tflint, ansible-lint, add SSH keys stubs
install:
  - wget https://releases.hashicorp.com/packer/1.2.1/packer_1.2.1_linux_amd64.zip
  - sudo unzip -o packer_1.2.1_linux_amd64.zip -d /usr/local/bin
  - wget https://releases.hashicorp.com/terraform/0.11.3/terraform_0.11.3_linux_amd64.zip
  - sudo unzip -o terraform_0.11.3_linux_amd64.zip -d /usr/local/bin
  - wget https://github.com/wata727/tflint/releases/download/v0.5.4/tflint_linux_amd64.zip
  - sudo unzip -o tflint_linux_amd64.zip -d /usr/local/bin
  - pip install ansible
  - pip install ansible-lint
  - touch ~/.ssh/appuser.pub && touch ~/.ssh/appuser

# Perform the tests: packer validate, terraform validate, tflint, ansible-lint
script:
  - cd packer
  - packer validate -var-file=variables.json.example app.json
  - packer validate -var-file=variables.json.example db.json
  - cd using-ansible
  - packer validate -var-file=../variables.json.example app.json
  - packer validate -var-file=../variables.json.example db.json
  - cd ../../terraform/${WORK_ENV}
  - terraform init
  - terraform validate --var-file=terraform.tfvars.example
  - tflint --var-file=terraform.tfvars.example --error-with-issues
  - ansible-lint ./ansible/playbooks/*.yml

# Notify about build result in Slack chat channel
notifications:
  slack:
    secure: vnNeFbQ0+t2vVSi9uSErlEeoAYn24avPc41wfGIurKGPTKFkaQpaMqKQCvoqvMporbuFaj09fH/7iLQ1k2O9AZ0s/gNhzWSeeu6a7s/UEspAR6JHjbYzJ6nUfEcfSgkOCP2C9m5LDTYB1kvbB1Wqs4S21ZhpJ3xwZDwTpdL592kYaX60qPIKueG7zGZjarCBq2jXun+do5W5CUyO77ixF4I2hg+aL8Q5dj8zAxzDbWyN0XQ6yBh6FYP4HyDDZNuEoA0kvy1xMzE6s+uMYtUmtXHlwyc4Piv5gGy76EvguhsJEt0YjhI4NhUwgUj8q16ri9Ce7aZrlzyJ3gnS7pDO4sZoK7j3Hgn5O+Fi61Tebims23oaf2QuzI9kjoligHO8+cF29+ffrxp3wDt4bcASShSqWqck1zCz6LkcU2Ehrt8nDpfTloaHDzuReby0fhrEZ6OZ1j3d9EswT8ZL+rrPAXPiC2bgm2zcEt1YvL9TC6toqo1PQUjj2rIJRhKRI4F36JJFxr0H4yCY0EweihKL/mfAq25iaWVSwG95eyefUDbgJXqsokDeNFgirM7omMp1i24DOe/yZCoUaPSTcz6S3oqU5SBTrqxK5rDB55D2+4hmHa4J0jHUGYhKy6qYNIz7BJV8qkXypbBGmENc95SZbbDc3En5x4bUzYbcX9UjusA=
